<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="/common.css" />
    <link rel="stylesheet" href="/lobby.css" />
    <link rel="stylesheet" href="/pico.cyan.min.css" />
    <title>Ophir 2D - Lobby</title>
</head>

<body>
    <div class="navbar">
        <button id="logout">Log Out</button>
    </div>
    <div class="content">
        <h3>Games</h3>
        <table>
            <thead>
                <tr>
                    <th>Game</th>
                    <th class="players">Players</th>
                    <th class="status">Status</th>
                    <th class="update">Last Update</th>
                    <th>Playing?</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script>
        const seconds = 1000;
        document.querySelector('#logout').addEventListener('click', () => {
            fetch('/logout').then(response => {
                if (response.status !== 200)
                    console.error(response.statusText);
                window.location.href = '/';
            });
        });

        getTableData().then(data => {
            drawTable(data);
        }).catch(error => {
            console.error(error);
            alert('Something went wrong.')
        });

        const update = setInterval(() => {
            getTableData().then(data => {
                drawTable(data);
            }).catch(error => {
                console.error(error);
                clearInterval(update);
                window.location.href = '/';
            });
        }, 3 * seconds)

        async function getTableData() {
            const dataFetch = await fetch('/feed');

            if (dataFetch.status !== 200) {
                throw new Error("Bad Request");
            }

            const data = await dataFetch.json();

            return data;
        }

        function drawTable(data) {
            const tableBody = document.querySelector('tbody');

            const tableContent = data.reduce((acc, current) => {
                return acc + getRow(current);
            }, '');

            // tableBody.innerHTML = tableContent + `<tr>${'<td></td>' * 5}<td><a href="/new">New Game</a></td></tr>`;
            tableBody.innerHTML = tableContent + '<tr> <td></td> <td class="players"></td> <td class="status"></td> <td class="update"></td> <td></td> <td><a href="/new">New Game</a></td> </tr>';

            function getRow(feed) {

                const { gameId, action, activity, status, userInvolvement, timeStamp } = feed;
                let { enrolled, active } = activity;

                let row = '<tr>';

                const style = {
                    dormant: 'class="dormant"',
                    active: 'class="active"',
                    important: 'class="important"',
                }

                // MARK: Title
                const title = gameId.split('-').map(str => str.charAt(0).toUpperCase() + str.slice(1)).join(' ');
                row += `<td>${title}</td>`;

                // MARK: Players
                let pips = ''
                for (let i = 0; i < enrolled; i++)
                    pips += `<div ${active-- > 0 ? style.active : style.dormant}></div>`;
                row += `<td class="players"><div class="pips">${pips}</div></td>`

                const statusText = (() => {
                    switch (status) {
                        case 0:
                            return 'Open'
                        case 1:
                        case 2:
                            return 'Started'
                        case 3:
                            return 'Abandoned'
                        default:
                            return 'N/A'
                    }
                })();

                // MARK: Status
                row += `<td  class="status" ${status == 2 ? style.dormant : style.active}>${statusText}</td>`

                // MARK: Last Update
                const age = Date.now() - timeStamp;
                const seconds = age / 1000;
                const minutes = seconds / 60;
                const ageText = (() => {
                    switch (true) {
                        case seconds < 60:
                            return `Seconds ago`
                        case minutes < 2:
                            return `A minute ago`
                        case minutes < 5:
                            return `${Math.ceil(minutes)} mins ago`
                        case minutes < 60:
                            return `${Math.round(minutes / 5) * 5} mins ago`
                        default:
                            const hours = Math.round(minutes / 60);
                            return `${hours} ${hours > 1 ? 'hrs' : 'hr'} ago`
                    }
                })();
                row += `<td class="update">${ageText}</td>`

                // Mark: User Involvement
                switch (userInvolvement) {
                    case 0:
                        row += '<td>no</td>'
                        break;
                    case 1:
                        row += '<td class="active">Yes</td>'
                        break;
                    case 2:
                        row += '<td class="your_turn">Your turn!</td>'
                }

                // MARK: Action
                row += action
                    ? `<td><a href="/${gameId}">${action}</a></td>`
                    : '<td>N/A</td>'

                row += '</tr>'

                return row;
            }
        }

    </script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
    <script>
        // CONSOLE DEBUG ON MOBILE
        eruda.init();
        console.log('DPR:', window.devicePixelRatio);
        console.log('screen.width:', window.screen.width);
        console.log('innerWidth:', window.innerWidth);
        console.log('Calculated CSS width:', window.screen.width / window.devicePixelRatio);
    </script> -->
</body>