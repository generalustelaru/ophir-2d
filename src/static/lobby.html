<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/lobby.css" />
    <link rel="stylesheet" href="/pico.cyan.min.css" />
    <title>Ophir 2D - Lobby</title>
</head>

<body>
    <a id="logout">Log out</a>
    <h3>Games</h3>
    <table>
        <thead>
            <tr>
                <td>Game</td>
                <td>Players</td>
                <td>Status</td>
                <td>Last Update</td>
                <td>Are you playing?</td>
                <td>Action</td>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script>
        const seconds = 1000;
        document.querySelector('#logout').addEventListener('click', () => {
            fetch('/logout').then(response => {
                if (response.status !== 200)
                    console.error(response.statusText);
                window.location.href = '/';
            });
        });

        getTableData().then(data => {
            drawTable(data);
        }).catch(error => {
            console.error(error);
            alert('Something went wrong.')
        });

        const update = setInterval(() => {
            getTableData().then(data => {
            drawTable(data);
        }).catch(error => {
            console.error(error);
            clearInterval(update);
            alert('Connection lost');
        });
        },10 * seconds)

        async function getTableData() {
            const dataFetch = await fetch('/feed');

            if (dataFetch.status !== 200) {
                throw new Error("Bad Request");
            }

            const data = await dataFetch.json();

            return data;
        }

        function drawTable(data) {
            const tableBody = document.querySelector('tbody');

            const tableContent = data.reduce((acc, current) => {
                return acc + getRow(current);
            }, '');

            // tableBody.innerHTML = tableContent + `<tr>${'<td></td>' * 5}<td><a href="/new">New Game</a></td></tr>`;
            tableBody.innerHTML = tableContent + '<tr><td></td><td></td><td></td><td></td><td></td><td><a href="/new">New Game</a></td></tr>';

            function getRow(feed) {

                const { gameId, action, activity, status, userInvolvement, timeStamp } = feed;
                let { enrolled, active } = activity;

                let row = '<tr>';

                const style = {
                    dormant: 'class="dormant"',
                    active: 'class="active"',
                    important: 'class="important"',
                }

                // MARK: Title
                const title = gameId.split('-').map(str => str.charAt(0).toUpperCase() + str.slice(1)).join(' ');
                row += `<td>${title}</td>`;

                // MARK: Players
                let pips = ''
                for (let i= 0; i < enrolled; i++)
                    pips += `<div ${active-- > 0 ? style.active : style.dormant}></div>`;
                row += `<td><div class="players">${pips}</div></td>`

                const statusText = (() => {
                    switch (status) {
                        case 0:
                            return 'Enroling'
                        case 1:
                            return 'Playing'
                        default:
                            return 'Dormant'
                    }
                })();

                // MARK: Status
                row += `<td ${status == 2 ? style.dormant : style.active}>${statusText}</td>`

                // MARK: Last Update
                const age = Date.now() - timeStamp;
                const seconds = age / 1000;
                const minutes = seconds / 60;
                const ageText = (() => {
                    switch (true) {
                        case seconds < 60:
                            return `Seconds ago`
                        case minutes < 2:
                            return `A minute ago`
                        case minutes < 5:
                            return `${Math.ceil(minutes)} minutes ago`
                        case minutes < 60:
                            return `${Math.round(minutes / 5) * 5} minutes ago`
                        default:
                            const hours = Math.round(minutes / 60);
                            return `${hours} ${hours > 1 ? 'hours' : 'hour'} ago`
                    }
                })();
                row +=`<td>${ageText}</td>`

                // Mark: User Involvement
                switch (userInvolvement) {
                    case 0:
                        row += '<td>no</td>'
                        break;
                    case 1:
                        row += '<td class="active">yes</td>'
                        break;
                    case 2:
                        row += '<td class="your_turn">Yes, it\'s your turn!</td>'
                }

                // MARK: Action
                row += action
                    ? `<td><a href="/${gameId}">${action}</a></td>`
                    : '<td>N/A</td>'

                row += '</tr>'

                return row;
            }
        }

    </script>
</body>