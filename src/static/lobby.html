<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/lobby.css" />
    <link rel="stylesheet" href="/pico.cyan.min.css" />
    <title>Ophir 2D - Lobby</title>
</head>

<body>
    <a id="logout">Log out</a>
    <h3>Games</h3>
    <table>
        <thead>
            <tr>
                <td>Action</td>
                <td>Players</td>
                <td>Status</td>
                <td>Are you playing?</td>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script>
        const seconds = 1000;
        document.querySelector('#logout').addEventListener('click', () => {
            fetch('/logout').then(response => {
                if (response.status !== 200)
                    console.error(response.statusText);
                window.location.href = '/';
            });
        });

        getTableData().then(data => {
            drawTable(data);
        }).catch(error => {
            console.error(error);
            alert('Something went wrong.')
        });

        const update = setInterval(() => {
            getTableData().then(data => {
            drawTable(data);
        }).catch(error => {
            console.error(error);
            clearInterval(update);
            alert('Connection lost');
        });
        },10 * seconds)

        async function getTableData() {
            const dataFetch = await fetch('/feed');

            if (dataFetch.status !== 200) {
                throw new Error("Bad Request");
            }

            const data = await dataFetch.json();

            return data;
        }

        function drawTable(data) {
            const tableBody = document.querySelector('tbody');

            const tableContent = data.reduce((acc, current) => {
                return acc + getRow(current);
            }, '');

            tableBody.innerHTML = tableContent + '<tr><td colspan="4"><a href="/new">New Game</a></td></tr>';

            function getRow(feed) {
                if (feed.gameId === null) {
                    return '<tr><td colspan="4"><a href="/new">Start New Game</a></td></tr>';
                }

                const { gameId, action, players, status, userInvolvement } = feed;
                let row = '<tr>';

                row += action
                    ? `<td><a href="/${gameId}">${action}</a></td>`
                    : '<td>N/A</td>'

                const style = status == 2 ? 'class="dormant"' : 'class="active"'

                let pips = ''
                for (let i= 0; i < players; i++)
                    pips += `<div ${style}></div>`;
                row += `<td><div class="players">${pips}</div></td>`

                const statusText = (() => {
                    switch (status) {
                        case 0:
                            return 'Enroling'
                        case 1:
                            return 'Playing'
                        default:
                            return 'Dormant'
                    }
                })();
                row += `<td ${style}>${statusText}</td>`

                switch (userInvolvement) {
                    case 0:
                        row += '<td>no</td>'
                        break;
                    case 1:
                        row += '<td class="active">yes</td>'
                        break;
                    case 2:
                        row += '<td class="your_turn">Yes and it\'s your turn!</td>'
                }

                row += '</tr>'

                return row;
            }
        }

    </script>
</body>