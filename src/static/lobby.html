<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/lobby.css" />
    <link rel="stylesheet" href="/pico.cyan.min.css" />
    <title>Ophir 2D - Lobby</title>
</head>

<body>
    <a id="logout">Log out</a>
    <h3>Games</h3>
    <table>
        <thead>
            <tr>
                <td>Action</td>
                <td>Players</td>
                <td>Status</td>
                <td>Your Involvement</td>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
    <script>
        document.querySelector('#logout').addEventListener('click', () => {
            fetch('/logout').then(response => {
                if (response.status !== 200)
                    console.error(response.statusText);
                window.location.href = '/';
            });
        });

        getTableData().then(data => {
            drawTable(data);
        }).catch(error => {
            console.error(error);
            alert('Something went wrong.')
        });

        async function getTableData() {
            const dataFetch = await fetch('/feed');

            if (dataFetch.status !== 200) {
                throw new Error("Bad Request");
            }

            const data = await dataFetch.json();

            return data;
        }

        function drawTable(data) {
            const tableBody = document.querySelector('tbody');

            const tableContent = data.reduce((acc, current) => {
                return acc + getRow(current);
            }, '');

            tableBody.innerHTML = tableContent;

            function getRow(feed) {
                if (feed.gameId === null) {
                    return '<tr><td colspan="4"><a href="/new">Start New Game</a></td></tr>';
                }

                const { gameId, action, players, status, userInvolvement } = feed;
                let row = '<tr>';

                row += action
                    ? `<td><a href="/${gameId}">${action}</a></td>`
                    : '<td>...</td>'

                let pips = ''
                for (let i= 0; i < players; i++)
                    pips += '<div></div>';
                row += `<td><div class="players">${pips}</div></td>`

                row += `<td>${status}</td>`

                switch (userInvolvement) {
                    case 0:
                        row += '<td></td>'
                        break;
                    case 1:
                        row += '<td>playing</td>'
                        break;
                    case 2:
                        row += '<td class="turn_mark">Your Turn!</td>'
                }

                row += '</tr>'

                return row;
            }
        }

    </script>
</body>